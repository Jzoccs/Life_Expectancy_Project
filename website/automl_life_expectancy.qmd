---
title: "AutoML Life Expectancy Dashboard"
format: html
jupyter: python3
execute:
    echo: false     # hide all code
---


This page explores how different regression models predict **life expectancy** using
a small set of economic and environmental features:

- **GDP per capita**
- **CO₂ emissions per capita**
- **Year**

We start with an animated view of the raw data, then move into model comparison:
a simple **Linear Regression** baseline and three tree-based models trained with
**FLAML AutoML**:

- **LightGBM (LGBM)** – a fast gradient boosting model
- **Random Forest (RF)** – an ensemble of decision trees
- **XGBoost** – a powerful gradient boosting algorithm

Each section of the page is designed to answer a specific question about model
performance and behavior.



```{python}
from pathlib import Path
import pandas as pd
import plotly.express as px
from IPython.display import Image

project_root = Path.cwd().parent

metrics = pd.read_csv(
    project_root / "data" / "processed" / "model_comparison_metrics.csv"
)
preds = pd.read_csv(
    project_root / "data" / "processed" / "test_predictions_life_expectancy_models.csv"
)

baseline = metrics[metrics["model"] == "linear_regression"].iloc[0]
best_r2_row = metrics.loc[metrics["r2"].idxmax()]
best_rmse_row = metrics.loc[metrics["rmse"].idxmin()]

best_model_name = best_r2_row["model"]
best_r2 = best_r2_row["r2"]
best_rmse = best_rmse_row["rmse"]

baseline_r2 = baseline["r2"]
baseline_rmse = baseline["rmse"]

r2_gain = best_r2 - baseline_r2
rmse_drop = baseline_rmse - best_rmse

# Paths to saved figures
viz_dir = project_root / "src" / "visualizations" / "automl_regression"
rmse_mae_png = viz_dir / "regression_rmse_mae_comparison.png"
r2_png = viz_dir / "regression_r2_comparison.png"
error_dist_png = viz_dir / "error_distributions_by_model.png"
```


```{python}
#| title: "R Squared Calculations"
Image(filename=str(r2_png), width=1000)
```
```{python}
#| title: "RMSE and MAE Comparison"
Image(filename=str(rmse_mae_png), width=1000)
```

```{python}
#| title: "Error Distributions by Model" 
Image(filename=str(error_dist_png), width=1000)
```

## Life Expectancy for each Regression Model

This graph compares the global trend in life expectancy over time to what each regression model thinks that trend looks like.

More concretely:

For every year, the data first computes the average life expectancy across all countries in the test set.
It does this both for the actual values (y_actual) and for the predictions from each model:

- **Linear Regression**
- **LightGBM (AutoML)**
- **Random Forest (AutoML)**
- **XGBoost (AutoML)**

The plot then shows five lines over time: one line for the true global mean life expectancy,
and one line for each model’s predicted global mean.

```{python}
#| title: "Global Mean Life Expectancy: Actual vs Model Predictions"
# Compute global average per year for actuals and all models
series_cols = [
    "y_actual",
    "y_pred_linear_regression",
    "y_pred_lgbm",
    "y_pred_rf",
    "y_pred_xgboost",
]

world = preds.groupby("year")[series_cols].mean().reset_index()

world_long = world.melt(
    id_vars="year",
    value_vars=series_cols,
    var_name="series",
    value_name="life_expectancy",
)

series_labels = {
    "y_actual": "Actual",
    "y_pred_linear_regression": "Linear Regression",
    "y_pred_lgbm": "LightGBM (AutoML)",
    "y_pred_rf": "Random Forest (AutoML)",
    "y_pred_xgboost": "XGBoost (AutoML)",
}

world_long["series"] = world_long["series"].map(series_labels)

fig = px.line(
    world_long,
    x="year",
    y="life_expectancy",
    color="series",
    labels={
        "year": "Year",
        "life_expectancy": "Mean life expectancy (years)",
        "series": "Series",
    },
)
fig.update_layout(
    legend_title_text="",
    hovermode="x unified",
    width=850,
    height=500,
    margin=dict(l=40, r=10, t=40, b=40),
)

```

## Example of the Data Used

The table below shows a **sample of the test-set data** that all of the AutoML visualizations are based on.  

Each row corresponds to a **single country–year** observation, and the columns mean:

- **Country** – The country the observation comes from.  
- **Year** – The year of the observation.  
- **Actual** – The **true** life expectancy (in years) from the dataset.  
- **Linear** – The life expectancy predicted by the **Linear Regression** baseline model.  
- **LGBM** – The prediction from the **LightGBM (AutoML)** model.  
- **RF** – The prediction from the **Random Forest (AutoML)** model.  
- **XGBoost** – The prediction from the **XGBoost (AutoML)** model.  

You can use this sample to see how the models behave at the individual country level:

- For some cases, the models are **very close** to the true value  
  - e.g., **Mongolia 1993** (Actual ≈ 60.8, all models around 62–63).  
- In other cases, certain models **overestimate** or **underestimate** life expectancy  
  - e.g., **Namibia 2009** (Actual ≈ 55.3, Linear Regression predicts over 66 years).  
- Different models sometimes **disagree with each other**  
  - e.g., **Iraq 2015** or **Ethiopia 1991**, where LGBM and XGBoost predict noticeably different values.

This is the same data used to build:

- the **error distribution** plots,  
- the **global mean life expectancy** comparison, and  
- the **model performance summaries** elsewhere on this page.


```{python}
#| title: "Test Set Predictions (sample)"
preds_display = preds[
    ["country_name", "year", "y_actual",
     "y_pred_linear_regression", "y_pred_lgbm", "y_pred_rf", "y_pred_xgboost"]
].copy()

preds_display.rename(
    columns={
        "country_name": "Country",
        "year": "Year",
        "y_actual": "Actual",
        "y_pred_linear_regression": "Linear",
        "y_pred_lgbm": "LGBM",
        "y_pred_rf": "RF",
        "y_pred_xgboost": "XGBoost",
    },
    inplace=True,
)

preds_display.head(25)
```
